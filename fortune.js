// ===== 3) ฐานข้อมูลคำทำนาย (Fortune Database) =====
// ⭐️ [แก้ไข] นี่คือ "ฐานข้อมูล" ใหม่ที่แก้ไขง่ายมาก
// แค่เพิ่ม { keywords: "...", text: "..." } เข้าไปใน good/bad ของแต่ละหมวด
// (ใช้ | เพื่อใส่หลายคีย์เวิร์ด)
const fortuneDB = {
  study: {
    good: [
      { keywords: "สติปัญญา|หน้าผากสูง|หน้าผากนูน|ส่วนบนเด่น|นักคิด", text: "หัวไวแบบไม่ได้โม้ สมองประมวลผลเร็วกว่า Wi-Fi ห้องสมุด แต่ก็อย่าเหลิง เพราะความขี้เกียจคือศัตรูตัวจริง" },
      { keywords: "คางแหลม|หน้าหัวใจ|คิ้วโก่ง|ศิลปิน|จินตนาการดี", text: "สายอาร์ตตัวแม่ ไอเดียสร้างสรรค์บรรเจิด แต่ถ้าเจอวิชาคำนวณคืออยากกุมขมับ... เน้นทำพอร์ตสวยๆ เข้าไว้!" },
      { keywords: "ตาชิด|คิ้วตรง|ตาสมดุล|โฟกัสเก่ง", text: "สายโฟกัส! ถ้าตั้งใจอ่านหนังสือคือเข้าหัวหมด แต่ถ้าติดเล่นเมื่อไหร่ ก็คือลืมโลกไปเลยเหมือนกัน" },
      { keywords: "สุขุม|จมูกยาว|หน้านักวิเคราะห์|รอบคอบ", text: "สายวิเคราะห์ ชอบวางแผนการอ่านหนังสือเป็นตาราง แต่บางทีก็วางแผนนานไปหน่อยจนไม่ได้เริ่มอ่านจริง" },
      { keywords: "สมดุล|หน้ารูปไข่", text: "เรียนได้ทุกวิชา แต่ถ้าไม่รีวิวก่อนสอบ ก็เหมือนเปิดตู้เย็นแล้วลืมว่ามาหาอะไร" }
    ],
    bad: [
      { keywords: "หน้าผากแคบ|หน้าผากแบน|ส่วนบนแคบ|วาสนาน้อย", text: "ต้องใช้ความพยายามมากกว่าคนอื่นหนึ่งสเต็ป ไม่ได้แปลว่าไม่เก่ง แค่ต้องขยันกว่าเดิม... สู้เขาลูกแม่!" },
      { keywords: "ตาห่าง|ใจร้อน|ร่องใต้จมูกสั้น|สมาธิสั้น", text: "สมาธิสั้นกว่าปลาทอง อ่านหนังสือได้ทีละ 5 นาทีแล้วไถมือถือต่อ แม่หมอแนะให้ปิดเน็ตก่อนอ่าน" }
    ],
    default: "ดวงการเรียนกลาง ๆ แต่อารมณ์คือไม่อ่านจนวินาทีสุดท้ายก็ไม่เริ่ม แบบนี้แม่หมอยกมือไหว้ละนะ"
  },
  work: {
    good: [
      { keywords: "ผู้นำ|โหนกแก้มเด่น|โหนกแก้มสูง|คางเหลี่ยม|ทะเยอทะยาน|หางตาชี้ขึ้น|สันจมูกโด่ง", text: "บอสในร่างพนักงาน แต่อย่าข่มคนอื่นเกินไป เดี๋ยวโดนหมั่นไส้ลับหลัง แม่หมอเตือนด้วยความหวังดี" },
      { keywords: "เป็นมิตร|เข้าสังคม|ปากกว้าง|หน้ากลม|คิ้วห่าง|ปากอวบอิ่ม", text: "คอนเนคชั่นแน่นกว่าเน็ต 5G ใคร ๆ ก็อยากร่วมงาน แต่ระวังพูดมากจนเผลอหลุดข้อมูลลับของบริษัท" },
      { keywords: "คิ้วตรง|หน้าสมมาตร|ตาสมดุล|จมูกยาว|มีระเบียบ", text: "สายเป๊ะ ทำงานมีระบบ ระเบียบจัด ไฟล์งานตั้งชื่อเป๊ะทุกตัวอักษร เหมาะกับงานบัญชีหรือตรวจสอบสุดๆ" },
      { keywords: "คางยื่น|หน้าสามเหลี่ยม|ส่วนกลางเด่น|นักสู้|ดื้อรั้น", text: "นักสู้ตัวจริง กัดไม่ปล่อย งานไม่เสร็จไม่กลับบ้าน แต่ระวังชนกับหัวหน้าบ่อยเพราะความดื้อนี่แหละ" }
    ],
    bad: [
      { keywords: "ขี้บ่น|ปากเบี้ยว|ไม่สมมาตร|ปากไม่สมมาตร|กรามเด่น|โหนกแก้มเด่นเกินไป|ก้าวร้าว", text: "งานก็เยอะ ปากก็ไว คำพูดคุณมีพลังมาก แต่ถ้าไม่กรองก่อนพูด ระวังห้อง HR จะโทรหา" },
      { keywords: "คางหลบ|โหนกแก้มต่ำ|สันจมูกแบน|หางคิ้วตก|คิ้วสั้น|โหนกแก้มไม่เด่น|ไม่มั่นใจ", text: "สายซัพพอร์ตโดยแท้ ทำงานเบื้องหลังเก่ง แต่ถ้าต้องนำเสนอจะประหม่า พกยาดมไว้เผื่อด้วย" }
    ],
    default: "ทำงานได้ทุกแนว แต่ไม่มีไฟจนกว่าเดดไลน์จะจ่อคอหอย งานออกมาดีเพราะแรงกดดันล้วน ๆ"
  },
  finance: {
    good: [
      { keywords: "การเงินดี|แก้มอิ่ม|จมูกได้สัดส่วน|สันจมูกโด่ง|บั้นปลายสุขสบาย", text: "เงินเข้าเร็วกว่าเงินออก แต่ใช้ก็เร็วกว่าแสงเช่นกัน เก็บเงินได้นะ แต่ต้องมีเป้าหมายจริง ๆ ถึงจะอยู่" },
      { keywords: "ปากอวบอิ่ม|คางกลม|มั่นคง|ส่วนล่างเด่น|เจ้าสำราญ", text: "สายกินสายเปย์ตัวจริง มีความสุขกับการใช้เงิน แต่ก็ยังเอาตัวรอดได้แบบฉิวเฉียดสิ้นเดือน" },
      { keywords: "หน้าเพชร|ทะเยอทะยาน|กล้าได้กล้าเสีย|ตาเล็ก", text: "ชอบความเสี่ยง กล้าได้กล้าเสีย อาจจะรวยจากหวยหรือคริปโต (หรือเจ๊ง) แต่ก็คิดมากเรื่องเงินตลอดเวลา" },
      { keywords: "หน้าผากเด่น|นักคิด|ปัญญาดี", text: "ใช้เงินซื้อประสบการณ์และความรู้ คอร์สเรียนอะไรมาใหม่ CF หมด... คุ้มค่าแหละ (มั้ง?)" }
    ],
    bad: [
      { keywords: "จมูกบาน|จมูกแบน|แก้มตอบ|จมูกสั้น|ปลายจมูกใหญ่|ส่วนล่างสั้น|เก็บเงินไม่อยู่", text: "กระเป๋าตังค์มีรูรั่ว! เงินเข้าปุ๊บ ออกปั๊บ เห็นป้ายลดราคาไม่ได้เลย ต้องหักห้ามใจบ้างนะ" }
    ],
    default: "รายจ่ายเยอะกว่ารายรับนิดหน่อย แต่ถ้ารู้จักตัดของฟุ่มเฟือยอย่างกาแฟแก้วละร้อย ก็รอดได้"
  },
  love: {
    good: [
      { keywords: "มุมปากชี้ขึ้น|ตาใหญ่|ปากอวบอิ่ม|คิ้วโก่ง|หน้าหัวใจ|มีเสน่ห์|ตาดำใหญ่", text: "เสน่ห์แรงเกินต้าน มีคนแอบส่องแต่ไม่กล้าทัก ถ้าเจ้ามีคู่อยู่แล้ว ระวังมือที่สามเพราะความฮอตของตัวเอง" },
      { keywords: "คางเหลี่ยม|หน้าเหลี่ยม|มั่นคง|จมูกยาว|คิ้วตรง", text: "รักใครรักจริง แต่ถ้าเลิกคือตัดขาด ไม่มีการรีเทิร์น เป็นสายจริงจัง ไม่ชอบความสัมพันธ์เล่นๆ" },
      { keywords: "คางแหลม|ศิลปิน|หน้าเพชร|หางตาชี้ขึ้น", text: "เบื่อง่าย เลือกเยอะ ชอบคนมีเอกลักษณ์เฉพาะตัว ถ้าไม่จี๊ดจริงไม่เอา ทำให้อยู่บนคานอย่างภาคภูมิใจ" },
      { keywords: "สมดุล|สุขุม|หน้าสมมาตร|คางกลม|ตาสมดุล", text: "ความรักเรียบง่ายแต่มั่นคง ไม่หวือหวาแต่ยั่งยืน เหมือนปลั๊กโทรศัพท์ที่ชาร์จช้าแต่เต็มแน่" }
    ],
    bad: [
      { keywords: "ขี้บ่น|ปากเบี้ยว|ใจร้อน|ตาชิด|คิ้วชิด|มุมปากตก|ไม่สมมาตร|ก้าวร้าว", text: "คู่อาจจะรักกันดีแต่ทะเลาะเก่งกว่าใคร ถ้าโสดอยู่ก็ยังไม่ควรรีบ เดี๋ยวเจอคนพูดมากกว่าอีก" },
      { keywords: "ปากแคบ|คางหลบ|หางตาตก|ตาเล็ก|เก็บตัว|ไม่มั่นใจ", text: "กำแพงสูงกว่าปราสาทเจ้าหญิงนิทรา ชอบใครก็ไม่กล้าบอก กลัวนกเก่ง... เปิดใจหน่อยเถอะแม่หมอขอ!" }
    ],
    default: "ยังไม่มีใครเพราะมาตรฐานสูงกว่าหอไอเฟล ถ้าลดลงมานิด ชีวิตจะไม่เหงาแบบนี้"
  },
  health: {
    good: [
      { keywords: "สุขภาพดี|แก้มอิ่ม|ร่องใต้จมูกยาว|ร่องใต้จมูกชัด|ตาดำใหญ่", text: "สุขภาพดีระดับแม่หมออิจฉา แต่ก็อย่าหักโหมเกินไป ร่างกายไม่ใช่ Powerbank 30,000 mAh" },
      { keywords: "ส่วนกลางเด่น|บ้าพลัง|คางยื่น|นักสู้", text: "พลังล้นเหลือเหมือนกินกระทิงมาทั้งฝูง แต่ระวังอุบัติเหตุเล็ก ๆ น้อย ๆ เพราะความซุ่มซ่ามของตัวเอง" }
    ],
    bad: [
      { keywords: "ปากบาง|แก้มตอบ|สุขภาพไม่ดี|ร่องใต้จมูกสั้น|ร่องใต้จมูกตื้น|ตาขาวลอย", text: "ช่วงนี้พลังตกง่ายกว่าหุ้นเทคโนโลยี ควรนอนให้เพียงพอและดื่มน้ำแทนน้ำตา อ้อ... ระวังออฟฟิศซินโดรมด้วย" },
      { keywords: "คิ้วชิด|ตาเล็ก|คิดมาก|หน้าผากแคบ|เครียดง่าย", text: "ระวังโรคเครียดลงกระเพาะ! ไมเกรนถามหาทุกวันจันทร์ คิดน้อยลงหน่อยก็ได้ ชีวิตไม่พังหรอกน่า" },
      { keywords: "จมูกสั้น|สันจมูกแบน|ภูมิแพ้", text: "ระวังเรื่องภูมิแพ้ อากาศเปลี่ยนทีไรจามก่อนใคร พกทิชชู่เยอะกว่าพกเงินในกระเป๋า" }
    ],
    default: "ไม่ป่วยก็จริง แต่พฤติกรรมกินดึกคือนางร้ายตัวจริง ถ้ายังไม่เลิก เดี๋ยวแม่หมอต้องดูให้ในโรงพยาบาล"
  }
};

// ⭐️ [เพิ่มใหม่] ฟังก์ชันผู้ช่วย: ค้นหาคำทำนายและสุ่ม
function getFortune(categoryDB, goodKeywords, badKeywords) {
  const matches = [];

  // 1. ตรวจสอบ Good Keywords
  categoryDB.good.forEach(entry => {
    const regex = new RegExp(entry.keywords, 'i');
    if (regex.test(goodKeywords)) {
      matches.push(entry.text);
    }
  });

  // 2. ตรวจสอบ Bad Keywords
  categoryDB.bad.forEach(entry => {
    const regex = new RegExp(entry.keywords, 'i');
    if (regex.test(badKeywords)) {
      matches.push(entry.text);
    }
  });

  // 3. ตัดสินใจ
  if (matches.length === 0) {
    // ไม่เจออะไรเลย -> คืนค่า Default
    return categoryDB.default;
  } else {
    // เจอคำทำนาย -> สุ่ม 1 อันจากที่เจอ
    const randomIndex = Math.floor(Math.random() * matches.length);
    return matches[randomIndex];
  }
}

// ⭐️ [แก้ไข] ฟังก์ชันหลักที่เรียกใช้ "ฐานข้อมูล"
export function generateOverallFortune(goodSigns, badSigns) {
  const fortune = {};
  const goodKeywords = goodSigns.join(' ');
  const badKeywords = badSigns.join(' ');

  fortune.study = getFortune(fortuneDB.study, goodKeywords, badKeywords);
  fortune.work = getFortune(fortuneDB.work, goodKeywords, badKeywords);
  fortune.finance = getFortune(fortuneDB.finance, goodKeywords, badKeywords);
  fortune.love = getFortune(fortuneDB.love, goodKeywords, badKeywords);
  fortune.health = getFortune(fortuneDB.health, goodKeywords, badKeywords);

  return `
【การเรียน】${fortune.study}
【การงาน】${fortune.work}
【การเงิน】${fortune.finance}
【ความรัก】${fortune.love}
【สุขภาพ】${fortune.health}
`;
}


// ===== 3.2) ทำนายรวมแบบคู่/กลุ่ม (ใช้ของเดิมได้) =====
export function generateGroupFortune(goodSigns, badSigns, n) {
  const goodText = goodSigns.join(' ');
  const badText = badSigns.join(' ');

  if (n === 2) {
    let mood = "";
    if (goodText.match(/เป็นมิตร|มุมปากชี้ขึ้น|หน้ากลม/)) {
      mood = "สองคนนี้ยิ้มเก่ง vibe ดีเกินต้าน เหมือนคู่ที่เจอกันในคาเฟ่แล้วรู้ใจทันที";
    } else if (goodText.match(/ผู้นำ|โหนกแก้มเด่น|ทะเยอทะยาน/) && goodText.match(/หางตาชี้ขึ้น|หน้าเพชร|สันจมูกโด่ง/)) {
      mood = "พาวเวอร์คัปเปิลชัดๆ! คู่นี้มีแววจะพากันไปรวย หรือไม่ก็พากันไปครองโลก แม่หมอฟันธง!";
    } else if (goodText.match(/คางแหลม|ศิลปิน|หน้าหัวใจ/) && goodText.match(/หน้าผากนูน|สร้างสรรค์|คิ้วโก่ง/)) {
      mood = "คู่สายอาร์ต คุยกันเรื่องงานศิลปะหรือซีรีส์เกาหลีได้ทั้งคืน เคมีจินตนาการตรงกันสุดๆ";
    } else if (goodText.match(/คางเหลี่ยม|หน้าเหลี่ยม|มั่นคง/) && goodText.match(/สุขุม|คิ้วตรง|ตาสมดุล/)) {
      mood = "คู่รักจริงจัง วางแผนอนาคตร่วมกัน ไม่หวือหวาแต่จริงใจ... แอบน่าเบื่อนิดหน่อยแต่ชัวร์";
    } else if (goodText.match(/สมดุล|ตาใหญ่|สุขุม|หน้าสมมาตร/)) {
      mood = "สายสบายแต่เข้าใจกันลึก ถ้าไม่ใช่แฟนก็คือเพื่อนที่อ่านใจกันออกทุกคำพูด";
    } else if (badText.match(/จุกจิก|ขี้บ่น|คิ้วชิด|ปากเบี้ยว/)) {
      mood = "คู่นี้มีแววเถียงกันบ่อยแต่ก็คืนดีกันไว เดทกันทีมีเรื่องให้คุยทั้งคืน (ส่วนใหญ่คือเรื่องบ่น)";
    } else if (goodKeywords.includes("ผู้นำ") && badKeywords.includes("คางหลบ")) {
      mood = "คู่แบบ 'คนหนึ่งนำ คนหนึ่งตาม' เคมีลงตัวแบบแม่เหล็กต่างขั้ว คนนึงสายลุย อีกคนสายซัพพอร์ต";
    } else {
      mood = "เคมีตรงพอดี มีทั้งไฟและความเข้าใจ แม่หมอให้ 9/10 ว่า ‘แอบปิ๊งกันอยู่’";
    }
    let summary = "ความสัมพันธ์นี้มีพลังแห่งการเติมเต็มกันและกัน ไม่ว่าจะเป็นเพื่อนหรือคนพิเศษ — เคมีเข้ากันสุดๆ";
    return `${mood}\n\n${summary}`;
  }

  // 3 คนขึ้นไป
  let mood = "", summary = "";
  if (goodText.match(/เป็นมิตร|สมดุล|ปากกว้าง|หน้ากลม|มุมปากชี้ขึ้น/)) {
    mood = "กลุ่มนี้ vibe ดีสุด ๆ เข้ากันได้แทบทุกเรื่อง ชอบหัวเราะและเติมพลังให้กันตลอด";
  } else if (goodText.match(/ผู้นำ|โหนกแก้มเด่น/) && badText.match(/ขี้บ่น|กรามเด่น|ไม่สมมาตร/)) {
    mood = "กลุ่มนี้มีผู้นำหลายคน เสียงดังทุกคนแต่สุดท้ายก็รักกันแน่นแฟ้น (แค่ตอนเลือกร้านข้าวนานหน่อย)";
  } else if (goodKeywords.match(/สร้างสรรค์|ศิลปิน|หน้าหัวใจ|คางแหลม|หน้าผากนูน/)) {
    mood = "แก๊งสายอาร์ตตัวแม่! รวมคนติสท์ไว้ในที่เดียว คุยกันรู้เรื่องอยู่กลุ่มเดียว แต่ไอเดียปังมาก";
  } else if (goodKeywords.match(/ส่วนกลางเด่น|นักสู้|คางยื่น|หน้าสามเหลี่ยม|บ้าพลัง/)) {
    mood = "แก๊งสายลุย นัดปุ๊บไปปั๊บ พลังเยอะ ไม่กลัวอะไร แค่ระวังอย่าพากันไปเจ็บตัวเพราะความห้าว";
  } else if (goodKeywords.match(/หน้าผากเด่น|ปัญญาดี|นักคิด|สุขุม|จมูกยาว/)) {
    mood = "แก๊งนักวิชาการ คุยเรื่องปรัชญา เถียงกันเรื่องทฤษฎี... เพื่อนกลุ่มอื่นอาจจะไม่เข้าใจว่าคุยอะไรกัน";
  } else if (badText.match(/ใจร้อน|จุกจิก|คิ้วชิด|ไม่สมมาตร/)) {
    mood = "มีความต่างกันชัดแต่กลับลงตัวอย่างประหลาด เหมือนวงบอยแบนด์ที่เถียงกันได้แต่ไม่แยกวง";
  } else {
    mood = "พลังกลุ่มนี้สมดุลดีมาก มีทั้งคนสายลุย สายมุข และสายซัพพอร์ต แม่หมออนุมัติให้เปิดวงดูดวงได้เลย";
  }

  if (n >= 5) summary = "ทีมใหญ่แต่หัวใจหนึ่งเดียว วงนี้มีแววจะดังในหมู่เพื่อนแน่";
  else if (n === 4) summary = "กลุ่มนี้ลงตัวสุด ๆ ไม่มีใครเด่นเกินใคร เหมาะกับทำโปรเจกต์หรือไปเที่ยวด้วยกันมาก";
  else if (n === 3) summary = "สามพลังแห่งมิตรภาพ ครบทุกคาแรกเตอร์ ทั้งสายเฮฮา สายติสท์ และสายคุมโทน";

  return `${mood}\n\nสรุป: ${summary}`;
}